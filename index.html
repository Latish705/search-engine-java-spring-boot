<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search Engine - Microservices Demo</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
        padding: 20px;
      }

      header h1 {
        font-size: 3em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .search-section {
        background: white;
        border-radius: 15px;
        padding: 40px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .search-box {
        position: relative;
        margin-bottom: 20px;
      }

      .search-input {
        width: 100%;
        padding: 18px 60px 18px 20px;
        font-size: 18px;
        border: 2px solid #667eea;
        border-radius: 50px;
        outline: none;
        transition: all 0.3s;
      }

      .search-input:focus {
        border-color: #764ba2;
        box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
      }

      .search-button {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 50px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s;
      }

      .search-button:hover {
        transform: translateY(-50%) scale(1.05);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .suggestions-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 10px;
        margin-top: 5px;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: none;
      }

      .suggestions-dropdown.active {
        display: block;
      }

      .suggestion-item {
        padding: 12px 20px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid #f0f0f0;
      }

      .suggestion-item:hover {
        background: #f5f5ff;
      }

      .suggestion-item:last-child {
        border-bottom: none;
      }

      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .card h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 1.8em;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .card-icon {
        font-size: 1.2em;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s;
        margin-bottom: 20px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn:active {
        transform: translateY(0);
      }

      .data-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .data-item {
        background: #f8f9ff;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 10px;
        border-left: 4px solid #667eea;
        transition: all 0.2s;
      }

      .data-item:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.2);
      }

      .query-text {
        font-weight: bold;
        color: #333;
        font-size: 1.1em;
        margin-bottom: 5px;
      }

      .query-meta {
        color: #666;
        font-size: 0.9em;
      }

      .frequency-badge {
        background: #667eea;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        display: inline-block;
        margin-left: 10px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error {
        background: #ffebee;
        color: #c62828;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        border-left: 4px solid #c62828;
      }

      .success {
        background: #e8f5e9;
        color: #2e7d32;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        border-left: 4px solid #2e7d32;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      .empty-state-icon {
        font-size: 3em;
        margin-bottom: 10px;
      }

      .delete-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 15px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 14px;
        float: right;
        transition: all 0.2s;
      }

      .delete-btn:hover {
        background: #c82333;
        transform: scale(1.05);
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-online {
        background: #4caf50;
        box-shadow: 0 0 10px #4caf50;
      }

      .status-offline {
        background: #f44336;
      }

      .service-status {
        margin-top: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 10px;
      }

      .service-status-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }

      @media (max-width: 768px) {
        .grid-container {
          grid-template-columns: 1fr;
        }

        header h1 {
          font-size: 2em;
        }

        .search-section {
          padding: 20px;
        }
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #764ba2;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üîç Search Engine</h1>
        <p>Powered by Microservices Architecture</p>
      </header>

      <!-- Search Section -->
      <div class="search-section">
        <h2 style="color: #667eea; margin-bottom: 20px">
          Search with Auto-Suggestions
        </h2>
        <div class="search-box">
          <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="Type to search and get suggestions..."
            autocomplete="off"
          />
          <button class="search-button" onclick="performSearch()">
            Search
          </button>
          <div id="suggestions" class="suggestions-dropdown"></div>
        </div>
        <div id="searchMessage"></div>
      </div>

      <!-- Grid Container for Cards -->
      <div class="grid-container">
        <!-- Analytics Logs Card -->
        <div class="card">
          <h2>
            <span class="card-icon">üìä</span>
            Query Analytics
          </h2>
          <button class="btn" onclick="loadAnalytics()">
            Load All Queries
          </button>
          <div id="analyticsData" class="data-list">
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <p>Click "Load All Queries" to view search history</p>
            </div>
          </div>
        </div>

        <!-- Aggregated Data Card -->
        <div class="card">
          <h2>
            <span class="card-icon">üìà</span>
            Popular Searches
          </h2>
          <button class="btn" onclick="runAggregation()">
            Run Aggregation
          </button>
          <button
            class="btn"
            onclick="loadAggregatedData()"
            style="
              background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            "
          >
            View Data
          </button>
          <div id="aggregatedData" class="data-list">
            <div class="empty-state">
              <div class="empty-state-icon">üìä</div>
              <p>Run aggregation to see popular searches</p>
            </div>
          </div>
        </div>

        <!-- Trie Builder Card -->
        <div class="card">
          <h2>
            <span class="card-icon">üå≥</span>
            Trie Data Structure
          </h2>
          <button
            class="btn"
            onclick="buildTrie()"
            style="
              background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            "
          >
            Build/Rebuild Trie
          </button>
          <div id="trieBuilderData" class="data-list">
            <div class="empty-state">
              <div class="empty-state-icon">üå≥</div>
              <p>
                Click "Build/Rebuild Trie" to create the search suggestion data
                structure
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Service Status Card -->
      <div class="card">
        <h2>
          <span class="card-icon">‚öôÔ∏è</span>
          Service Status
        </h2>
        <button class="btn" onclick="checkServiceStatus()">
          Check All Services
        </button>
        <div id="serviceStatus" class="service-status">
          <p style="color: #666">
            Click "Check All Services" to verify connectivity
          </p>
        </div>
      </div>
    </div>

    <script>
      // Configuration
      const config = {
        analyticsService: "http://localhost:8080/api/queries",
        aggregatorService: "http://localhost:8090/aggregate",
        workersService: "http://localhost:8100",
      };

      let debounceTimeout;

      // Search Input Event Listener for Suggestions
      document
        .getElementById("searchInput")
        .addEventListener("input", function (e) {
          clearTimeout(debounceTimeout);
          const query = e.target.value.trim();

          if (query.length === 0) {
            document.getElementById("suggestions").classList.remove("active");
            return;
          }

          debounceTimeout = setTimeout(() => {
            fetchSuggestions(query);
          }, 300);
        });

      // Close suggestions when clicking outside
      document.addEventListener("click", function (e) {
        if (!e.target.closest(".search-box")) {
          document.getElementById("suggestions").classList.remove("active");
        }
      });

      // Fetch Suggestions from Workers Service
      async function fetchSuggestions(query) {
        try {
          const response = await fetch(
            `${config.workersService}/search?q=${encodeURIComponent(query)}`
          );

          if (!response.ok) throw new Error("Failed to fetch suggestions");

          const suggestions = await response.json();
          displaySuggestions(suggestions);
        } catch (error) {
          console.error("Error fetching suggestions:", error);
          document.getElementById("suggestions").classList.remove("active");
        }
      }

      // Display Suggestions
      function displaySuggestions(suggestions) {
        const suggestionsDiv = document.getElementById("suggestions");

        if (!Array.isArray(suggestions) || suggestions.length === 0) {
          suggestionsDiv.classList.remove("active");
          return;
        }

        suggestionsDiv.innerHTML = suggestions
          .map((suggestion) => {
            // Handle both string and object formats
            const queryText =
              typeof suggestion === "string" ? suggestion : suggestion.query;
            const frequency =
              typeof suggestion === "object" && suggestion.frequency
                ? ` <span style="color: #999; font-size: 0.9em;">(${suggestion.frequency})</span>`
                : "";

            return `<div class="suggestion-item" onclick="selectSuggestion('${escapeHtml(
              queryText
            )}')">${escapeHtml(queryText)}${frequency}</div>`;
          })
          .join("");

        suggestionsDiv.classList.add("active");
      }

      // Select Suggestion
      function selectSuggestion(suggestion) {
        document.getElementById("searchInput").value = suggestion;
        document.getElementById("suggestions").classList.remove("active");
        performSearch();
      }

      // Perform Search - Log the query
      async function performSearch() {
        const query = document.getElementById("searchInput").value.trim();
        const messageDiv = document.getElementById("searchMessage");

        if (!query) {
          showMessage(messageDiv, "Please enter a search query", "error");
          return;
        }

        // Hide suggestions
        document.getElementById("suggestions").classList.remove("active");

        try {
          // Log the query to Analytics Service
          const response = await fetch(config.analyticsService, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ query: query }),
          });

          if (response.ok) {
            showMessage(
              messageDiv,
              `‚úÖ Search query "${query}" logged successfully!`,
              "success"
            );
            // Optionally reload analytics
            setTimeout(() => loadAnalytics(), 500);
          } else {
            throw new Error("Failed to log query");
          }
        } catch (error) {
          console.error("Error logging search:", error);
          showMessage(
            messageDiv,
            "‚ùå Failed to log search query. Make sure Analytics service is running.",
            "error"
          );
        }
      }

      // Load Analytics Data
      async function loadAnalytics() {
        const dataDiv = document.getElementById("analyticsData");
        showLoading(dataDiv);

        try {
          const response = await fetch(config.analyticsService);

          if (!response.ok) throw new Error("Failed to fetch analytics");

          const queries = await response.json();

          if (queries.length === 0) {
            dataDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>No queries logged yet. Try searching something!</p>
                        </div>
                    `;
            return;
          }

          dataDiv.innerHTML = queries
            .map(
              (item) => `
                    <div class="data-item">
                        <div class="query-text">${escapeHtml(item.query)}</div>
                        <div class="query-meta">
                            ID: ${item.id} | Logged: ${formatTimestamp(
                item.timestamp
              )}
                        </div>
                        <button class="delete-btn" onclick="deleteQuery(${
                          item.id
                        })">Delete</button>
                    </div>
                `
            )
            .join("");
        } catch (error) {
          console.error("Error loading analytics:", error);
          dataDiv.innerHTML = `<div class="error">Failed to load analytics data. Make sure the Analytics service is running on port 8080.</div>`;
        }
      }

      // Delete Query
      async function deleteQuery(id) {
        if (!confirm("Are you sure you want to delete this query?")) return;

        try {
          const response = await fetch(`${config.analyticsService}/${id}`, {
            method: "DELETE",
          });

          if (response.ok) {
            loadAnalytics();
          } else {
            alert("Failed to delete query");
          }
        } catch (error) {
          console.error("Error deleting query:", error);
          alert("Failed to delete query");
        }
      }

      // Run Aggregation
      async function runAggregation() {
        const dataDiv = document.getElementById("aggregatedData");
        showLoading(dataDiv);

        try {
          const response = await fetch(`${config.aggregatorService}/run`, {
            method: "POST",
          });

          if (!response.ok) throw new Error("Failed to run aggregation");

          const result = await response.text();
          dataDiv.innerHTML = `<div class="success">${result}</div>`;

          // Auto-load aggregated data after running aggregation
          setTimeout(() => loadAggregatedData(), 1000);
        } catch (error) {
          console.error("Error running aggregation:", error);
          dataDiv.innerHTML = `<div class="error">Failed to run aggregation. Make sure the Aggregator service is running on port 8090.</div>`;
        }
      }

      // Load Aggregated Data
      async function loadAggregatedData() {
        const dataDiv = document.getElementById("aggregatedData");
        showLoading(dataDiv);

        try {
          const response = await fetch(`${config.aggregatorService}/data`);

          if (!response.ok) throw new Error("Failed to fetch aggregated data");

          const data = await response.json();

          if (data.length === 0) {
            dataDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <p>No aggregated data available. Run aggregation first!</p>
                        </div>
                    `;
            return;
          }

          // Sort by frequency descending
          data.sort((a, b) => b.frequency - a.frequency);

          dataDiv.innerHTML = data
            .map(
              (item, index) => `
                    <div class="data-item">
                        <div class="query-text">
                            ${index + 1}. ${escapeHtml(item.query)}
                            <span class="frequency-badge">${
                              item.frequency
                            } searches</span>
                        </div>
                        <div class="query-meta">
                            Last updated: ${formatTimestamp(item.lastUpdated)}
                        </div>
                    </div>
                `
            )
            .join("");
        } catch (error) {
          console.error("Error loading aggregated data:", error);
          dataDiv.innerHTML = `<div class="error">Failed to load aggregated data. Make sure the Aggregator service is running on port 8090.</div>`;
        }
      }

      // Build Trie
      async function buildTrie() {
        const dataDiv = document.getElementById("trieBuilderData");
        showLoading(dataDiv);

        try {
          const response = await fetch(`${config.workersService}/build-trie`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) throw new Error("Failed to build trie");

          const result = await response.json();

          // Display success message with details
          dataDiv.innerHTML = `
            <div class="success">
              <strong>‚úÖ Trie built successfully!</strong>
              <div style="margin-top: 10px;">
                ${
                  result.message ||
                  "The trie data structure has been created from the aggregated queries."
                }
              </div>
            </div>
            ${
              result.details
                ? `
              <div class="data-item" style="margin-top: 15px;">
                <div class="query-text">Build Details</div>
                <div class="query-meta">
                  ${Object.entries(result.details)
                    .map(
                      ([key, value]) =>
                        `<div style="margin: 5px 0;"><strong>${key}:</strong> ${value}</div>`
                    )
                    .join("")}
                </div>
              </div>
            `
                : ""
            }
            <div class="data-item" style="margin-top: 15px;">
              <div class="query-meta">
                <strong>‚ÑπÔ∏è Note:</strong> The trie is now updated with the latest search queries. 
                Try typing in the search box above to see auto-suggestions powered by the trie!
              </div>
            </div>
          `;
        } catch (error) {
          console.error("Error building trie:", error);
          dataDiv.innerHTML = `
            <div class="error">
              <strong>‚ùå Failed to build trie</strong>
              <div style="margin-top: 10px;">
                Make sure the Workers service is running on port 8100 and there is aggregated data available.
              </div>
              <div style="margin-top: 10px; font-size: 0.9em;">
                <strong>Steps to resolve:</strong>
                <ol style="margin-left: 20px; margin-top: 5px;">
                  <li>Search some queries to create data</li>
                  <li>Run aggregation to process the queries</li>
                  <li>Then build the trie</li>
                </ol>
              </div>
            </div>
          `;
        }
      }

      // Check Service Status
      async function checkServiceStatus() {
        const statusDiv = document.getElementById("serviceStatus");
        statusDiv.innerHTML =
          '<div class="loading"><div class="spinner"></div>Checking services...</div>';

        const services = [
          { name: "Analytics Logs", url: config.analyticsService, port: 8080 },
          {
            name: "Aggregator",
            url: config.aggregatorService + "/data",
            port: 8090,
          },
          {
            name: "Workers (Suggestions)",
            url: config.workersService + "/search?q=test",
            port: 8100,
          },
        ];

        const statuses = await Promise.all(
          services.map(async (service) => {
            try {
              const response = await fetch(service.url, {
                method: "GET",
                signal: AbortSignal.timeout(5000),
              });
              return {
                ...service,
                online: response.ok,
                status: response.status,
              };
            } catch (error) {
              return {
                ...service,
                online: false,
                error: error.message,
              };
            }
          })
        );

        statusDiv.innerHTML = statuses
          .map(
            (service) => `
                <div class="service-status-item">
                    <span class="status-indicator ${
                      service.online ? "status-online" : "status-offline"
                    }"></span>
                    <strong>${service.name}</strong> (Port ${service.port}): 
                    ${
                      service.online
                        ? `<span style="color: #4caf50;">‚úì Online</span>`
                        : `<span style="color: #f44336;">‚úó Offline</span>`
                    }
                </div>
            `
          )
          .join("");
      }

      // Helper Functions
      function showLoading(element) {
        element.innerHTML =
          '<div class="loading"><div class="spinner"></div>Loading...</div>';
      }

      function showMessage(element, message, type) {
        element.innerHTML = `<div class="${type}">${message}</div>`;
        setTimeout(() => {
          element.innerHTML = "";
        }, 5000);
      }

      function formatTimestamp(timestamp) {
        if (!timestamp) return "N/A";
        const date = new Date(timestamp);
        return date.toLocaleString();
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Auto-check service status on page load
      window.addEventListener("load", () => {
        checkServiceStatus();
      });

      // Handle Enter key in search input
      document
        .getElementById("searchInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            performSearch();
          }
        });
    </script>
  </body>
</html>
